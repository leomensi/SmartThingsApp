<div class="app-container">

  <!-- Loading State -->
  <div class="loading-screen" *ngIf="loading()">
    <div class="spinner"></div>
    <p>Connecting to AC System...</p>
  </div>

  <!-- Error State -->
  <div class="error-screen" *ngIf="error()">
    <div class="error-box">
      <h2>Connection Failed</h2>
      <p>{{ error() }}</p>
      <button class="btn btn-primary" (click)="loadData()">Retry</button>

      <!-- Inline token box so user can submit new token from error screen -->
      <div style="margin-top:16px;">
        <div class="token-box card">
          <div class="token-title">24h Token (Update to regain access)</div>
          <input class="token-input" [(ngModel)]="tokenValue" placeholder="Enter token - must contain '-'" />
          <div style="display:flex; gap:8px; margin-top:8px; align-items:center;">
            <button class="btn btn-primary btn-sm" (click)="saveToken()">Save Token</button>
            <div class="token-countdown">{{ tokenCountdownText() }}</div>
          </div>
          <div *ngIf="tokenError" class="token-error">{{ tokenError }}</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Main App -->
  <div class="dashboard" *ngIf="!loading() && !error()">

    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <h1>Climate Control</h1>
        <div style="display: flex; gap: 8px; align-items: center;">
          <div class="status-badge">Online</div>
          <button class="btn btn-sm" (click)="exportCsv()" title="Export CSV">
            ‚¨áÔ∏è
          </button>
        </div>
      </div>

      <!-- Token device box -->
      <div class="token-box card">
        <div class="token-title">24h Token</div>
        <input class="token-input" [(ngModel)]="tokenValue" placeholder="Enter token - must contain '-'" />
        <div style="display:flex; gap:8px; margin-top:8px; align-items:center;">
          <button class="btn btn-primary btn-sm" (click)="saveToken()">Save</button>
          <div class="token-countdown">{{ tokenCountdownText() }}</div>
        </div>
        
        <div *ngIf="tokenError" class="token-error">{{ tokenError }}</div>
      </div>

      <div class="device-list">
        <div class="device-item" *ngFor="let device of devices()" [class.active]="isSelected(device)"
          (click)="selectDevice(device)">
          <div class="device-info">
            <span class="device-name">{{ device.deviceName }}</span>
            <div style="display: flex; gap: 8px; font-size: 0.8rem; color: var(--text-secondary);">
              <span>{{ device.location }}</span>
              <span *ngIf="device.humidity != null">üíß {{ device.humidity | number:'1.0-0' }}%</span>
            </div>
          </div>
          <div class="device-stat">
            {{ device.todayKWh | number:'1.1-1' }} <small>kWh</small>
          </div>
        </div>
      </div>
    </aside>

    <!-- Content Area -->
    <main class="content">
      <ng-container *ngIf="selectedDevice() as current">

        <!-- Header -->
        <header class="content-header">
          <div>
            <h2>{{ current.deviceName }}</h2>
            <div class="last-update">Updated: {{ formatLastUpdate(current.lastUpdate) }}</div>
          </div>
          <div class="location-tag">{{ current.location }}</div>
        </header>

        <!-- KPI Cards -->
        <div class="kpi-grid">
          <!-- KPI 1 -->
          <div class="card kpi-card">
            <div class="kpi-title">Today's Usage</div>
            <div class="kpi-value">{{ current.todayKWh | number:'1.2-2' }} <span>kWh</span></div>
          </div>
          <!-- KPI 2 -->
          <div class="card kpi-card">
            <div class="kpi-title">24h Usage</div>
            <div class="kpi-value">{{ current.rolling24hKWh | number:'1.2-2' }} <span>kWh</span></div>
          </div>
          <!-- KPI 3 -->
          <div class="card kpi-card">
            <div class="kpi-title">Temperature</div>
            <div class="kpi-value">
              <ng-container *ngIf="current.temperatureC">{{ current.temperatureC | number:'1.0-1' }}¬∞</ng-container>
              <ng-container *ngIf="!current.temperatureC">--</ng-container>
            </div>
          </div>
          <!-- KPI 4 -->
          <div class="card kpi-card">
            <div class="kpi-title">Mode</div>
            <div class="kpi-value mode-value">
              {{ current.airConditionerMode || 'OFF' }}
            </div>
            <div class="kpi-sub" *ngIf="current.fanMode">Fan: {{ current.fanMode }}</div>
          </div>
        </div>

        <!-- Charts -->
        <div class="card section">
          <h3>Hourly Consumption (24h)</h3>
          <div class="chart-container" *ngIf="selectedHourly().length > 0; else noChart">
            <div class="bar-group" *ngFor="let point of selectedHourly()">
              <div class="bar" [style.height]="hourlyBarHeight(point.kWh)" [title]="point.kWh + ' kWh'"></div>
              <div class="bar-label">{{ point.hour | date:'HH' }}</div>
            </div>
          </div>
          <ng-template #noChart>
            <div class="empty-state">No hourly data available</div>
          </ng-template>
        </div>

        <!-- History -->
        <div class="card section">
          <div class="section-header">
            <h3>Recent History</h3>
            <button class="btn btn-sm" (click)="loadHistoryForCurrent()" [disabled]="historyLoading()">
              {{ historyLoading() ? 'Loading...' : 'Refresh' }}
            </button>
          </div>

          <div class="table-container" *ngIf="history().length > 0; else noHistory">
            <table class="data-table">
              <thead>
                <tr>
                  <th>Time</th>
                  <th>Energy</th>
                  <th>Temp</th>
                  <th>Humidity</th>
                  <th>Mode</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let row of history()">
                  <td>{{ row.timestamp | date:'HH:mm' }}</td>
                  <td>{{ row.deltaKWh | number:'1.3-3' }}</td>
                  <td>{{ row.temperatureC ? (row.temperatureC | number:'1.1-1') + '¬∞' : '--' }}</td>
                  <td>{{ row.humidity ? (row.humidity | number:'1.0-0') + '%' : '--' }}</td>
                  <td>{{ row.airConditionerMode || '-' }}</td>
                </tr>
              </tbody>
            </table>
          </div>
          <ng-template #noHistory>
            <div class="empty-state">Click Refresh to see detailed history.</div>
          </ng-template>
        </div>

      </ng-container>
    </main>
  </div>
</div>